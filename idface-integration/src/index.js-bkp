require('dotenv').config();
    const express = require('express');
    const routes = require('./routes');
    const logger = require('./utils/logger');
    const config = require('./config');
    const idFaceService = require('./services/idface.service');
    const PushController = require('./controllers/push.controller');
    const pushController = new PushController();
    const path = require('path');

    const app = express();

    // Log de requisiÃ§Ãµes (exceto heartbeat e polling)
    app.use((req, res, next) => {
        const isHeartbeat = req.url.includes('device_is_alive');
        const isPolling = req.url.startsWith('/push') && req.method === 'GET';
        const isNotificationsPolling = req.path === '/api/notifications' && req.method === 'GET';
        
        if (isHeartbeat && !config.logs.showHeartbeat) return next();
        if ((isPolling || isNotificationsPolling) && !config.logs.showPolling) return next();
        
        logger.info(`${req.method} ${req.url} - IP: ${req.ip}`);
        next();
    });

    app.use(express.json({ limit: '50mb' }));
    app.use(express.urlencoded({ extended: true, limit: '50mb' }));

    // Health check
    app.get('/health', (req, res) => {
        res.json({ status: 'ok', timestamp: new Date().toISOString() });
    });

    // ============ ENDPOINTS DO DISPOSITIVO ============

    app.post('/device_is_alive.fcgi', (req, res) => {
        if (config.logs.showHeartbeat) logger.info('Heartbeat received');
        res.json({ alive: true });
    });

    app.get('/push', (req, res) => {
        if (config.logs.showPolling) logger.debug('Push polling from device:', req.query.deviceId);
        pushController.getCommand(req, res);
    });

    app.post('/result', (req, res) => {
        logger.info('Push result received from device:', req.query.deviceId);
        pushController.postResult(req, res);
    });

    app.get('/api/notifications', (req, res) => {
        if (config.logs.showPolling) logger.debug(`[POLLING] Device: ${req.query.deviceId}`);
        res.json([]);
    });

    app.post('/api/notifications/operation_mode', (req, res) => {
        const event = req.body;
        logger.info(`[MODE] ${event.operation_mode?.mode_name || 'N/A'} - Device: ${event.device_id || 'N/A'}`);
        res.json({});
    });

    app.post('/api/notifications/dao', async (req, res) => {
        const data = req.body;
        
        // Log detalhado do DAO
        logger.info('==========================================');
        logger.info('ðŸ“¦ DAO - Data Access Object');
        logger.info('==========================================');
        
        // Processar mudanÃ§as de objetos
        if (data.object_changes && Array.isArray(data.object_changes)) {
            for (const change of data.object_changes) {
                if (change.object === 'access_logs' && change.type === 'inserted') {
                    const accessLog = change.values;
                    const userId = parseInt(accessLog.user_id);
                    const eventId = parseInt(accessLog.event);
                    const horario = new Date(parseInt(accessLog.time) * 1000).toLocaleString('pt-BR');
                    
                    // Buscar informaÃ§Ãµes do usuÃ¡rio
                    try {
                        const userInfo = await idFaceService.getUserById(userId);
                        
                        logger.info('==========================================');
                        logger.info('ðŸŽ¯ ACESSO REGISTRADO!');
                        logger.info('==========================================');
                        logger.info(`ðŸ‘¤ Nome: ${userInfo?.name || 'N/A'}`);
                        logger.info(`ðŸ†” User ID: ${userId}`);
                        logger.info(`ðŸ”‘ Identifier ID: ${accessLog.identifier_id}`);
                        logger.info(`ðŸ“‹ MatrÃ­cula: ${userInfo?.registration || 'N/A'}`);
                        logger.info(`ðŸ“Š ConfianÃ§a: ${accessLog.confidence}`);
                        logger.info(`ðŸ˜· MÃ¡scara: ${accessLog.mask === '1' ? 'SIM' : 'NÃƒO'}`);
                        logger.info(`ðŸšª Portal: ${accessLog.portal_id}`);
                        logger.info(`ðŸ“… Event ID: ${eventId}`);
                        logger.info(`â° HorÃ¡rio: ${horario}`);
                        logger.info('==========================================');
                    } catch (error) {
                        logger.warn('==========================================');
                        logger.warn('âš ï¸ ACESSO DETECTADO - Erro ao buscar usuÃ¡rio');
                        logger.warn(`ðŸ†” User ID: ${userId}`);
                        logger.warn(`ðŸ“Š ConfianÃ§a: ${accessLog.confidence}`);
                        logger.warn(`â° HorÃ¡rio: ${horario}`);
                        logger.warn(`âŒ Erro: ${error.message}`);
                        logger.warn('==========================================');
                    }
                }
            }
        }
        
        logger.info('Payload completo:', JSON.stringify(data, null, 2));
        logger.info('==========================================');
        
        res.json({});
    });

    app.post('/api/notifications/secbox', (req, res) => {
        const data = req.body;
        
        // Log detalhado do SECBOX
        logger.info('==========================================');
        logger.info('ðŸ”’ SECBOX - Evento de SeguranÃ§a');
        logger.info('==========================================');
        logger.info('Payload completo:', JSON.stringify(data, null, 2));
        logger.info('==========================================');
        
        res.json({});
    });

    // Adicione tambÃ©m handler para device_is_alive no caminho correto
    app.post('/api/notifications/device_is_alive', (req, res) => {
        const data = req.body;
        
        if (config.logs.showHeartbeat) {
            logger.info('ðŸ’“ Heartbeat via notifications');
            logger.info(`Access logs: ${data.access_logs}`);
        }
        
        res.json({});
    });

    // ============ MODO MONITOR ============

    // ADICIONE ESTE BLOCO ANTES DOS HANDLERS
    app.post('/api/notifications/*', (req, res, next) => {
        logger.info('==========================================');
        logger.info(`ðŸ” EVENTO CAPTURADO: ${req.path}`);
        logger.info('==========================================');
        logger.info('Body completo:', JSON.stringify(req.body, null, 2));
        logger.info('==========================================');
        next();
    });

    function handleUserIdentified(req, res) {
        const event = req.body;
        const userId = parseInt(event.user_id) || 0;
        const userName = event.user_name || '';
        const eventId = event.event ? parseInt(event.event) : undefined;
        const horario = event.time ? new Date(parseInt(event.time) * 1000).toLocaleString('pt-BR') : 'N/A';
        
        console.log('');
        
        if (userId > 0 && userName) {
            logger.info('==========================================');
            logger.info('ðŸŽ¯ USUÃRIO IDENTIFICADO!');
            logger.info('==========================================');
            logger.info(`ðŸ‘¤ Nome: ${userName}`);
            logger.info(`ðŸ†” User ID: ${userId}`);
            logger.info(`ðŸ“‹ MatrÃ­cula: ${event.registration || 'N/A'}`);
            logger.info(`ðŸ“Š ConfianÃ§a: ${event.confidence || 'N/A'}`);
            logger.info(`ðŸ˜· MÃ¡scara: ${event.face_mask === '1' ? 'SIM' : 'NÃƒO'}`);
            logger.info(`â° HorÃ¡rio: ${horario}`);
            logger.info('==========================================');
        } else {
            logger.warn('==========================================');
            logger.warn('ðŸ‘¤ ROSTO DETECTADO - NÃƒO IDENTIFICADO');
            logger.warn(`ðŸ“Š ConfianÃ§a: ${event.confidence || 'N/A'}`);
            logger.warn(`â° HorÃ¡rio: ${horario}`);
            logger.warn('==========================================');
        }
        
        console.log('');
        
        res.setHeader('Content-Type', 'application/json');
        res.status(200).json({
            result: {
                user_id: String(userId),
                user_name: userName,
                event: eventId,
                actions: []
            }
        });
    }

    function handleUserNotIdentified(req, res) {
        const event = req.body;
        const eventId = event.event ? parseInt(event.event) : undefined;
        const horario = event.time ? new Date(parseInt(event.time) * 1000).toLocaleString('pt-BR') : 'N/A';
        
        console.log('');
        logger.warn('==========================================');
        logger.warn('âš ï¸ USUÃRIO NÃƒO IDENTIFICADO!');
        logger.warn(`â° HorÃ¡rio: ${horario}`);
        logger.warn('==========================================');
        console.log('');
        
        res.setHeader('Content-Type', 'application/json');
        res.status(200).json({
            result: {
                user_id: -1,
                user_name: '',
                event: eventId,
                actions: []
            }
        });
    }

    app.post('/new_user_identified.fcgi', handleUserIdentified);
    app.post('/user_not_identified.fcgi', handleUserNotIdentified);
    app.post('/api/notifications/new_user_identified.fcgi', handleUserIdentified);
    app.post('/api/notifications/user_not_identified.fcgi', handleUserNotIdentified);

    // ============ Rotas da API interna ============
    app.use('/api', routes);

    // ============ Catch-all para debug ============
    app.all('*', (req, res) => {
        logger.warn(`[NÃƒO MAPEADO] ${req.method} ${req.url}`);
        logger.warn(`Body: ${JSON.stringify(req.body)}`);
        res.json({});
    });

    // ============ INICIALIZAÃ‡ÃƒO ============

    async function startServer() {
        try {
            logger.info('==========================================');
            logger.info('ðŸš€ Iniciando servidor IDFace Integration');
            logger.info('==========================================');
            logger.info(`ðŸ“‹ Dispositivo: ${config.device.ip}`);
            logger.info(`ðŸ“‹ Porta: ${config.server.port}`);
            
            await idFaceService.authenticate();
            
            const deviceInfo = await idFaceService.getDeviceInfo();
            logger.info(`ðŸ“± Dispositivo: ${deviceInfo.device_name}`);
            logger.info(`ðŸ”¢ Serial: ${deviceInfo.serial}`);
            logger.info(`ðŸ“¡ Firmware: ${deviceInfo.version}`);
            
            app.locals.deviceSession = idFaceService.session;
            logger.info(`ðŸ”‘ SessÃ£o ativa: ${idFaceService.session}`);
            
            app.listen(config.server.port, '0.0.0.0', () => {
                console.log('');
                logger.info('==========================================');
                logger.info(`âœ… Servidor rodando na porta ${config.server.port}`);
                logger.info(`ðŸ”‡ Heartbeat logs: ${config.logs.showHeartbeat ? 'ON' : 'OFF'}`);
                logger.info(`ðŸ”‡ Polling logs: ${config.logs.showPolling ? 'ON' : 'OFF'}`);
                logger.info(`ðŸ” API Key: ${config.auth.apiKey ? 'ATIVA' : 'DESABILITADA'}`);
                logger.info('==========================================');
                console.log('');
            });
            
        } catch (error) {
            logger.error(`âŒ Erro ao iniciar: ${error.message}`);
            
            app.listen(config.server.port, '0.0.0.0', () => {
                logger.info(`Servidor rodando na porta ${config.server.port} (modo offline)`);
            });
        }
    }

    startServer();

    // Servir UI de testes
    app.use('/ui', express.static(path.join(__dirname, 'public')));