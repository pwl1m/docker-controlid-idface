<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>IDFace - Teste UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .block { border: 1px solid #ddd; padding: 12px; margin: 10px 0; border-radius: 6px; }
    .block h3 { margin: 0 0 8px 0; }
    .block textarea { width: 100%; min-height: 90px; }
    .block input[type="text"] { width: 420px; }
    .block select { min-width: 110px; }
    .muted { color: #666; font-size: 12px; }
    .output { white-space: pre-wrap; background: #f7f7f7; padding: 10px; border-radius: 4px; }
    .ok { color: #1a7f37; font-weight: bold; }
    .err { color: #b00020; font-weight: bold; }
  </style>
</head>
<body>
  <h1>IDFace - Teste UI (Único)</h1>
  <p class="muted">Base URL é opcional. Ex.: <code>http://192.168.10.18:3001</code></p>

  <div class="row">
    <label>Base URL:</label>
    <input id="baseUrl" type="text" placeholder="http://192.168.10.18:3001" />
  </div>
  <div class="row">
    <label>API Key (opcional):</label>
    <input id="apiKey" type="text" placeholder="x-api-key" />
  </div>

  <!-- LOGIN -->
  <div class="block">
    <h3>Login (backend -> device)</h3>
    <div class="row">
      <button onclick="doLogin()">Login</button>
      <span id="loginStatus" class="muted">Sessão: -</span>
    </div>
    <p class="muted">
      Obs: o backend usa as credenciais do <code>.env</code>. Este botão apenas força reautenticação
      e mostra a sessão retornada.
    </p>
  </div>

  <!-- PING -->
  <div class="block">
    <h3>Ping (device/info)</h3>
    <div class="row">
      <button onclick="doPing()">Ping</button>
      <span id="pingStatus" class="muted">Status: -</span>
    </div>
    <p class="muted">Verifica se o backend consegue falar com o dispositivo.</p>
  </div>

  <h2>Objetos (create/load/update/delete)</h2>

  <div class="block">
    <h3>Users</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
      </select>
      <input class="path" type="text" value="/api/users" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "name": "Usuario Teste", "registration": "123" }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Groups</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/groups" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "name": "Departamento A" }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Access Rules</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/access-rules" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "name": "Regra 1", "type": 0, "priority": 0 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Group Access Rules</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/group-access-rules" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "group_id": 1, "access_rule_id": 1 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>User Access Rules</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/user-access-rules" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "user_id": 1, "access_rule_id": 1 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Scheduled Unlocks</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/scheduled-unlocks" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "name": "Liberacao Agendada" }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Scheduled Unlock Access Rules</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/scheduled-unlock-access-rules" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "scheduled_unlock_id": 1, "access_rule_id": 1 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Time Zones</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/time-zones" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "name": "Horario A" }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Time Spans</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/time-spans" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "time_zone_id": 1, "start": 28800, "end": 61200, "mon": 1, "tue": 1, "wed": 1, "thu": 1, "fri": 1 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Access Rule Time Zones</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/access-rule-time-zones" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "access_rule_id": 1, "time_zone_id": 1 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Holidays</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
        <option>POST</option>
        <option>PATCH</option>
        <option>DELETE</option>
      </select>
      <input class="path" type="text" value="/api/holidays" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "values": [
    { "name": "Feriado Teste", "date": 1704067200 }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Access Logs</h3>
    <div class="row">
      <select class="method">
        <option>GET</option>
      </select>
      <input class="path" type="text" value="/api/access-logs" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <h2>Device Tests (Cadastro Facial)</h2>

  <div class="block">
    <h3>Obter imagem do usuário</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-get-image?user_id=10&get_timestamp=1" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Listar usuários com imagem</h3>
    <div class="row">
      <select class="method"><option>GET</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-list-images?get_timestamp=1" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Obter lista de imagens</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-get-image-list" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "user_ids": [27, 28]
}</textarea>
  </div>

  <div class="block">
    <h3>Cadastrar imagem do usuário (arquivo)</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-set-image?user_id=10&match=1" />
      <input class="file" type="file" />
      <button onclick="sendBlock(this, true)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Cadastrar lista de imagens (base64)</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-set-image-list" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "match": true,
  "user_images": [
    { "user_id": 27, "timestamp": 1624997563, "image": "/9j/4AAQSkZJRgABAQ..." }
  ]
}</textarea>
  </div>

  <div class="block">
    <h3>Testar imagem (arquivo)</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-test-image" />
      <input class="file" type="file" />
      <button onclick="sendBlock(this, true)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Excluir fotos de usuários</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/user-destroy-image" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "user_ids": [27, 28]
}</textarea>
  </div>

  <div class="block">
    <h3>Captura de câmera (screenshot)</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/save-screenshot" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "frame_type": "camera",
  "camera": "rgb"
}</textarea>
  </div>

  <div class="block">
    <h3>Config: Limitar à região de display</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/config-limit-display" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Config: Brilho do LED</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/config-led-brightness" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{ "brightness": "100" }</textarea>
  </div>

  <div class="block">
    <h3>Config: Distância mínima de detecção</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/device-tests/face/config-min-distance" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{ "min_detect_bounds_width": "0.29" }</textarea>
  </div>

  <h2>Interfonia SIP</h2>

  <div class="block">
    <h3>Obter Configuração SIP</h3>
    <div class="row">
      <select class="method"><option>GET</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/config" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Definir Configuração SIP</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/config" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "pjsip": {
    "enabled": "1",
    "server_ip": "sip.exemplo.com",
    "server_port": "5060",
    "branch": "1000",
    "login": "1000",
    "password": "senhasip",
    "auto_answer_enabled": "0",
    "auto_answer_delay": "3",
    "dialing_display_mode": "dial_pad",
    "auto_call_target": "",
    "video_enabled": "0",
    "max_call_time": "60",
    "rex_enabled": "0"
  }
}</textarea>
  </div>

  <div class="block">
    <h3>Fazer Chamada SIP</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/call" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "target": "1001"
}</textarea>
  </div>

  <div class="block">
    <h3>Finalizar Chamada SIP</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/call/finalize" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{}</textarea>
  </div>

  <div class="block">
    <h3>Status SIP</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/call/status" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{}</textarea>
  </div>

  <div class="block">
    <h3>Upload Áudio SIP (arquivo .wav)</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/audio" />
      <input class="file" type="file" accept=".wav,audio/*" />
      <button onclick="sendBlock(this, true)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Obter Áudio SIP</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/audio/get" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{}</textarea>
  </div>

  <div class="block">
    <h3>Verificar Áudio SIP</h3>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/interfonia-sip/audio/exists" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{}</textarea>
  </div>

  <h2>Custódia (Simples e Dupla)</h2>

  <div class="block">
    <h3>Obter Config de Identificação/Custódia</h3>
    <p class="muted">Lê general, identifier e pjsip — mostra modo atual (1:N, 1:1, dupla custódia)</p>
    <div class="row">
      <select class="method"><option>GET</option></select>
      <input class="path" type="text" value="/api/custody/config" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <div class="block">
    <h3>Setup: Simples Custódia (PIN + Face 1:1)</h3>
    <p class="muted">Configura device para modo verify (1:1) com multi_factor = face+PIN</p>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/custody/setup/simple" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "access_rule_name": "Custódia Simples - PIN + Face",
  "min_score": "0.83",
  "identification_timeout": "30"
}</textarea>
  </div>

  <div class="block">
    <h3>Setup: Dupla Custódia (PIN + Face + SIP + DTMF)</h3>
    <p class="muted">Após PIN+Face, device liga para SOC. Operador abre porta via DTMF.</p>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/custody/setup/dual" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "sip_target": "503",
  "open_door_command": "#1234",
  "video_enabled": "1",
  "max_call_time": "120",
  "min_score": "0.83",
  "access_rule_name": "Dupla Custódia - SOC"
}</textarea>
  </div>

  <div class="block">
    <h3>Teste/Validação do Fluxo</h3>
    <p class="muted">Verifica se todas as configs estão corretas (checklist pass/fail)</p>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/custody/test" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{
  "sip_target": "503"
}</textarea>
  </div>

  <div class="block">
    <h3>Reset: Voltar ao Modo Padrão (1:N face-only)</h3>
    <p class="muted">Restaura tudo: 1:N, sem PIN, sem dupla custódia, sem auto-call</p>
    <div class="row">
      <select class="method"><option>POST</option></select>
      <input class="path" type="text" value="/api/custody/setup/reset" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body">{}</textarea>
  </div>

  <h2>Device Info</h2>

  <div class="block">
    <h3>Informações do dispositivo</h3>
    <div class="row">
      <select class="method"><option>GET</option></select>
      <input class="path" type="text" value="/api/device/info" />
      <button onclick="sendBlock(this)">Enviar</button>
    </div>
    <textarea class="body"></textarea>
  </div>

  <h2>Resposta</h2>
  <pre id="output" class="output"></pre>

  <div class="row">
    <label>Debug:</label>
    <input id="debugMode" type="checkbox" />
    <span class="muted">Mostrar headers e resposta bruta</span>
  </div>

  <script>
    function buildUrl(path) {
      const base = document.getElementById('baseUrl').value.trim();
      if (!base) return path;
      if (path.startsWith('http://') || path.startsWith('https://')) return path;
      return base.replace(/\/$/, '') + path;
    }

    function buildHeaders(isFile = false) {
      const headers = {};
      const apiKey = document.getElementById('apiKey')?.value?.trim();
      if (apiKey) headers['x-api-key'] = apiKey;
      if (!isFile) headers['Content-Type'] = 'application/json';
      return headers;
    }

    async function doLogin() {
      const url = buildUrl('/api/login');
      const headers = buildHeaders();
      try {
        const res = await fetch(url, { method: 'POST', headers, body: '{}' });
        const text = await res.text();
        const data = (() => { try { return JSON.parse(text); } catch { return {}; } })();

        const status = document.getElementById('loginStatus');
        if (res.ok && data.session) {
          status.textContent = `Sessão: ${data.session}`;
          status.className = 'ok';
        } else {
          status.textContent = `Falha no login (${res.status})`;
          status.className = 'err';
        }

        const debugInfo = isDebug()
          ? `\n\n[Headers]\n${formatHeaders(res)}\n\n[Raw]\n${text}`
          : '';
        const formatted = Object.keys(data).length ? JSON.stringify(data, null, 2) : text;

        document.getElementById('output').textContent =
          `Login Status: ${res.status}\n\n${formatted}${debugInfo}`;
      } catch (err) {
        const status = document.getElementById('loginStatus');
        status.textContent = `Erro: ${err.message}`;
        status.className = 'err';
        if (isDebug()) document.getElementById('output').textContent = `Erro: ${err.message}`;
      }
    }

    async function doPing() {
      const url = buildUrl('/api/device/info');
      const headers = buildHeaders();
      const statusEl = document.getElementById('pingStatus');
      try {
        const res = await fetch(url, { method: 'GET', headers });
        const text = await res.text();
        let formatted = text;
        try { formatted = JSON.stringify(JSON.parse(text), null, 2); } catch {}

        if (!res.ok) {
          statusEl.textContent = `Status: ${res.status}`;
          statusEl.className = 'err';
        } else {
          statusEl.textContent = 'Status: OK';
          statusEl.className = 'ok';
        }

        const debugInfo = isDebug()
          ? `\n\n[Headers]\n${formatHeaders(res)}\n\n[Raw]\n${text}`
          : '';

        document.getElementById('output').textContent =
          `Ping Status: ${res.status}\n\n${formatted}${debugInfo}`;
      } catch (err) {
        statusEl.textContent = `Erro: ${err.message}`;
        statusEl.className = 'err';
        if (isDebug()) document.getElementById('output').textContent = `Erro: ${err.message}`;
      }
    }

    function isDebug() {
      return document.getElementById('debugMode')?.checked;
    }

    function formatHeaders(res) {
      const out = [];
      res.headers.forEach((v, k) => out.push(`${k}: ${v}`));
      return out.join('\n');
    }

    async function sendBlock(btn, isFile = false) {
      const block = btn.closest('.block');
      const method = block.querySelector('.method').value;
      const path = block.querySelector('.path').value.trim();
      const body = block.querySelector('.body')?.value ?? '';
      const fileInput = block.querySelector('.file');
      const url = buildUrl(path);

      let payload = undefined;
      let headers = buildHeaders(isFile);

      if (isFile && fileInput && fileInput.files.length) {
        const file = fileInput.files[0];
        payload = await file.arrayBuffer();
        headers['Content-Type'] = file.type || 'application/octet-stream';
      } else if (method !== 'GET') {
        payload = body ? body : '{}';
      }

      try {
        const res = await fetch(url, { method, headers, body: payload });
        const text = await res.text();
        let formatted = text;
        try { formatted = JSON.stringify(JSON.parse(text), null, 2); } catch {}

        const debugInfo = isDebug()
          ? `\n\n[Headers]\n${formatHeaders(res)}\n\n[Raw]\n${text}`
          : '';

        document.getElementById('output').textContent =
          `Status: ${res.status}\n\n${formatted}${debugInfo}`;
      } catch (err) {
        document.getElementById('output').textContent = `Erro: ${err.message}`;
      }
    }
  </script>
</body>
</html>